<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub Code Macro - Renderer</title>
  <script src="https://connect-cdn.atl-paas.net/all.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    .loading {
      padding: 20px;
      text-align: center;
      color: #6b778c;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
    }
    .error {
      padding: 10px;
      background-color: #ffebe6;
      border-radius: 3px;
      color: #de350b;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
    }
  </style>
</head>
<body>
  <div id="content" class="loading">Loading GitHub code snippet...</div>
  
  <script>
    // Initialize Atlassian Connect
    AP.require(['confluence'], function(confluence) {
      
      // Get macro parameters
      confluence.getMacroData(function(data) {
        if (!data) {
          document.getElementById('content').innerHTML = `
            <div class="error">
              <strong>Error:</strong> Missing macro parameters.
            </div>
          `;
          return;
        }
        
        let githubUrl;
        
        // Check if we have the direct URL parameter (new format)
        if (data.url) {
          githubUrl = data.url;
        } 
        // Backward compatibility with old format
        else if (data.repository && data.path) {
          const repository = data.repository;
          const path = data.path;
          const branch = data.branch || 'main';
          githubUrl = `https://github.com/${repository}/blob/${branch}/${path}`;
        } else {
          document.getElementById('content').innerHTML = `
            <div class="error">
              <strong>Error:</strong> Missing required GitHub URL.
            </div>
          `;
          return;
        }
        
        const lines = data.lines || '';
        const theme = data.theme || 'github';
        
        // Get base URL from current window location
        const baseUrl = window.location.origin;
        
        // Fetch rendered code from our service
        fetch(`${baseUrl}/html?url=${encodeURIComponent(githubUrl)}&lines=${encodeURIComponent(lines)}&theme=${encodeURIComponent(theme)}`, {
          headers: {
            'User-Agent': 'Mozilla/5.0'
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Error fetching code: ${response.status}`);
          }
          return response.text();
        })
        .then(html => {
          document.getElementById('content').innerHTML = html;
          
          // Resize the iframe to fit content
          resizeToFitContent();
        })
        .catch(error => {
          document.getElementById('content').innerHTML = `
            <div class="error">
              <strong>Error loading GitHub code:</strong> ${error.message}<br>
              Please check that the GitHub URL is correct.
            </div>
          `;
          
          // Resize the iframe to fit error message
          resizeToFitContent();
        });
      });
      
      // Helper function to resize the iframe
      function resizeToFitContent() {
        const content = document.getElementById('content');
        const height = content.offsetHeight;
        
        // Tell Confluence to resize the iframe
        AP.resize('100%', height + 10); // Add a little padding
      }
    });
  </script>
</body>
</html> 