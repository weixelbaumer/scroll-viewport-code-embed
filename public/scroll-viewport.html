<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scroll Viewport JavaScript Solution</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <style>
    body {
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    pre {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .alert {
      margin-top: 20px;
    }
    .nav-pills .nav-link.active {
      background-color: #6c757d;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">Scroll Viewport JavaScript Solution</h1>
    <div class="alert alert-danger">
      <strong>IMPORTANT:</strong> Scroll Viewport filters out HTML tags. This solution uses JavaScript injection to work around this limitation.
    </div>
    
    <div class="row mt-4">
      <div class="col-md-3">
        <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
          <button class="nav-link active" id="method1-tab" data-bs-toggle="pill" data-bs-target="#method1" type="button" role="tab">JavaScript Method</button>
          <button class="nav-link" id="method2-tab" data-bs-toggle="pill" data-bs-target="#method2" type="button" role="tab">Text Marker Method</button>
          <button class="nav-link" id="method3-tab" data-bs-toggle="pill" data-bs-target="#method3" type="button" role="tab">Custom Theme</button>
        </div>
      </div>
      <div class="col-md-9">
        <div class="tab-content" id="v-pills-tabContent">
          <div class="tab-pane fade show active" id="method1" role="tabpanel" aria-labelledby="method1-tab">
            <h3>JavaScript Injection Method</h3>
            <p>This method uses JavaScript to load and render GitHub code after the page has loaded:</p>
            
            <ol>
              <li>Add this script to your Confluence page using the HTML macro:</li>
            </ol>
            
            <pre><code>&lt;script&gt;
document.addEventListener('DOMContentLoaded', function() {
  // Create a placeholder element
  var placeholder = document.createElement('div');
  placeholder.textContent = 'Loading GitHub code...';
  
  // Insert the placeholder where you want the code to appear
  var currentScript = document.currentScript;
  currentScript.parentNode.insertBefore(placeholder, currentScript);
  
  // Fetch the GitHub code
  fetch('https://<span id="current-host">SERVER_URL</span>/html?url=https://github.com/itext/itext7/blob/develop/kernel/src/main/java/com/itextpdf/kernel/pdf/PdfDocument.java&lines=100-120&theme=github')
    .then(function(response) { return response.text(); })
    .then(function(html) {
      // Create a temporary container
      var tempContainer = document.createElement('div');
      tempContainer.innerHTML = html;
      
      // Replace the placeholder with the actual content
      placeholder.parentNode.replaceChild(tempContainer.firstChild, placeholder);
    })
    .catch(function(error) {
      placeholder.textContent = 'Error loading GitHub code: ' + error.message;
    });
});
&lt;/script&gt;</code></pre>
            
            <p class="mt-3">Replace the GitHub URL with your desired file URL. This script:</p>
            <ul>
              <li>Creates a placeholder where the code will appear</li>
              <li>Fetches the rendered HTML from our server</li>
              <li>Injects it into the page after it's loaded</li>
            </ul>
            
            <div class="alert alert-info">
              Scroll Viewport can't filter out this code because it's injected after the page has loaded!
            </div>
          </div>
          
          <div class="tab-pane fade" id="method2" role="tabpanel" aria-labelledby="method2-tab">
            <h3>Text Marker Method</h3>
            <p>Use a text marker in your Confluence content that will be replaced with code:</p>
            
            <ol>
              <li>First, add this script to the top of your Confluence page using the HTML macro:</li>
            </ol>
            
            <pre><code>&lt;script&gt;
document.addEventListener('DOMContentLoaded', function() {
  // Find all text nodes in the document
  var walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
  var textNodes = [];
  var node;
  
  while (node = walker.nextNode()) {
    textNodes.push(node);
  }
  
  // Process each text node
  textNodes.forEach(function(textNode) {
    var text = textNode.nodeValue;
    if (text.includes('##GITHUB:')) {
      // Find the GitHub URL marker
      var pattern = /##GITHUB:([^#]+)##/g;
      var matches = text.match(pattern);
      
      if (matches && matches.length > 0) {
        // Split the text at the marker
        var parts = text.split(/##GITHUB:[^#]+##/);
        var parent = textNode.parentNode;
        
        // Remove the original text node
        parent.removeChild(textNode);
        
        // Add the text parts and GitHub code
        var position = 0;
        for (var i = 0; i < parts.length; i++) {
          // Add the text part
          if (parts[i]) {
            parent.insertBefore(document.createTextNode(parts[i]), null);
          }
          
          // Add GitHub code if there's a marker
          if (i < matches.length) {
            var url = matches[i].replace('##GITHUB:', '').replace('##', '');
            
            // Create placeholder
            var placeholder = document.createElement('div');
            placeholder.textContent = 'Loading GitHub code...';
            parent.insertBefore(placeholder, null);
            
            // Load the code (immediately invoked function to create closure)
            (function(placeholder, url) {
              fetch('https://<span class="current-host">SERVER_URL</span>/html?url=' + encodeURIComponent(url))
                .then(function(response) { return response.text(); })
                .then(function(html) {
                  var tempContainer = document.createElement('div');
                  tempContainer.innerHTML = html;
                  placeholder.parentNode.replaceChild(tempContainer.firstChild, placeholder);
                })
                .catch(function(error) {
                  placeholder.textContent = 'Error loading GitHub code: ' + error.message;
                });
            })(placeholder, url);
          }
        }
      }
    }
  });
});
&lt;/script&gt;</code></pre>
            
            <p class="mt-3">Then place text markers where you want code to appear:</p>
            
            <pre><code>Here is some example Java code:

##GITHUB:https://github.com/itext/itext7/blob/develop/kernel/src/main/java/com/itextpdf/kernel/pdf/PdfDocument.java##

The code above shows how to use PdfDocument.</code></pre>
            
            <div class="alert alert-info">
              This approach allows you to place multiple code snippets throughout your content!
            </div>
          </div>
          
          <div class="tab-pane fade" id="method3" role="tabpanel" aria-labelledby="method3-tab">
            <h3>Custom Theme Integration</h3>
            <p>If you have access to the Scroll Viewport theme, you can add this code to the theme's JavaScript:</p>
            
            <pre><code>// GitHub Code Renderer for Scroll Viewport
(function() {
  // Process text markers when the page is ready
  document.addEventListener('DOMContentLoaded', function() {
    // First, find all text markers in the format ##GITHUB:URL##
    var walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
    var textNodes = [];
    var node;
    
    while (node = walker.nextNode()) {
      textNodes.push(node);
    }
    
    // Process each text node
    textNodes.forEach(function(textNode) {
      var text = textNode.nodeValue;
      if (text.includes('##GITHUB:')) {
        // Find all GitHub URL markers
        var pattern = /##GITHUB:([^#:]+)(?::([^:]+))?(?::([^#]+))?##/g;
        var matches = [];
        var match;
        
        while ((match = pattern.exec(text)) !== null) {
          matches.push({
            fullMatch: match[0],
            url: match[1],
            lines: match[2] || '',
            theme: match[3] || 'github'
          });
        }
        
        if (matches.length > 0) {
          // Split the text at the markers
          var parts = text.split(/##GITHUB:[^#]+##/);
          var parent = textNode.parentNode;
          
          // Remove the original text node
          parent.removeChild(textNode);
          
          // Add the text parts and GitHub code
          for (var i = 0; i < parts.length; i++) {
            // Add the text part
            if (parts[i]) {
              parent.insertBefore(document.createTextNode(parts[i]), null);
            }
            
            // Add GitHub code if there's a marker
            if (i < matches.length) {
              var githubData = matches[i];
              
              // Create placeholder
              var placeholder = document.createElement('div');
              placeholder.textContent = 'Loading GitHub code...';
              parent.insertBefore(placeholder, null);
              
              // Load the code (immediately invoked function to create closure)
              (function(placeholder, data) {
                var url = 'https://<span class="current-host">SERVER_URL</span>/html' +
                          '?url=' + encodeURIComponent(data.url) + 
                          '&theme=' + encodeURIComponent(data.theme) +
                          (data.lines ? '&lines=' + encodeURIComponent(data.lines) : '');
                
                fetch(url)
                  .then(function(response) { return response.text(); })
                  .then(function(html) {
                    var tempContainer = document.createElement('div');
                    tempContainer.innerHTML = html;
                    placeholder.parentNode.replaceChild(tempContainer.firstChild, placeholder);
                  })
                  .catch(function(error) {
                    placeholder.textContent = 'Error loading GitHub code: ' + error.message;
                  });
              })(placeholder, githubData);
            }
          }
        }
      }
    });
  });
})();</code></pre>
            
            <p class="mt-3">With this approach you can use markers in your content like:</p>
            
            <pre><code>Basic example:
##GITHUB:https://github.com/itext/itext7/blob/develop/kernel/src/main/java/com/itextpdf/kernel/pdf/PdfDocument.java##

With line range:
##GITHUB:https://github.com/itext/itext7/blob/develop/kernel/src/main/java/com/itextpdf/kernel/pdf/PdfDocument.java:100-120##

With line range and theme:
##GITHUB:https://github.com/itext/itext7/blob/develop/kernel/src/main/java/com/itextpdf/kernel/pdf/PdfDocument.java:100-120:dracula##</code></pre>
            
            <div class="alert alert-info">
              This is the most elegant solution if you have theme access. It automatically processes all code markers on every page!
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Update the server URL in all examples
    document.addEventListener('DOMContentLoaded', function() {
      const serverUrl = window.location.origin;
      const hostElements = document.querySelectorAll('#current-host, .current-host');
      hostElements.forEach(function(el) {
        el.textContent = serverUrl;
      });
    });
  </script>
</body>
</html> 